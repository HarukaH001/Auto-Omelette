import React, { useEffect, useState } from 'react';
import './Content.scss';
import { Icon } from '@iconify/react';
import coinIcon from '@iconify/icons-twemoji/coin';
import eggIcon from '@iconify/icons-emojione/egg';
import broccoliIcon from '@iconify/icons-openmoji/broccoli';
import * as go from 'gojs';
import { ReactDiagram } from 'gojs-react';

export const Content = () => {
    const [priceComponent, setPC] = useState()
    const [price, setPrice] = useState(20)
    const [eggComponent, setEC] = useState()
    const [egg, setEgg] = useState(1)
    const [miscComponent, setMC] = useState()
    const [misc, setMisc] = useState([0, 0, 0])
    const [miscMax, setMM] = useState(0)
    useEffect(() => {
        // console.log(price, egg, misc, miscMax)
        setPC(renderPC())
        setEC(renderEC())
        setMC(renderMC())
        // eslint-disable-next-line
    }, [price, egg, misc, miscMax])
    function validation() {
        let cost = egg * 10 + misc.reduce((a, b) => a + b, 0) * 5 + 10
        let balance = price - cost
        return balance === 0 ? 'validated' : 'disabled'
    }
    function priceHandler(e, value) {
        setPrice(value)
        if (value <= 25) {
            setEgg(1)
        } else if (value === 40) {
            setEgg(2)
        }
        setMisc([0, 0, 0])
    }
    function eggHandler(e, value, limit) {
        if (value * 10 + 10 <= price && !(value === 1 && price === 40)) {
            setEgg(value)
        }
        setMisc([0, 0, 0])

    }
    function miscHandler(e, index) {
        let temp = [...misc]
        if (misc.reduce((a, b) => a + b, 0) < miscMax) temp[index]++
        setMisc(temp)
    }
    function miscRHandler(e, index) {
        e.preventDefault()

        let temp = [0, 0, 0]
        // let temp = [...misc]
        // if(misc[index] > 0) temp[index]--
        setMisc(temp)

        return false
    }
    function renderPC() {
        const LST = [20, 30, 40]
        return LST.map(iter => {

            return (
                <div key={'p' + iter} className={"control-btn " + (price === iter ? 'selected' : '')} onClick={e => priceHandler(e, iter)}>
                    {iter}
                </div>
            )
        })
    }
    function renderEC() {
        const LST = [1, 2]
        return LST.map(iter => {

            return (
                <div key={'e' + iter} className={"control-btn " + (egg === iter ? 'selected ' : '') + (iter * 10 + 10 > price || (price === 40 && iter === 1) ? 'disabled' : '')} onClick={e => eggHandler(e, iter)}>
                    {iter} ฟอง
                </div>
            )
        })
    }
    function renderMC() {
        const LST = ['หมูสับ', 'ไก่สับ']

        let cost = egg * 10 + misc.reduce((a, b) => a + b, 0) * 5 + 10
        let balance = price - cost
        let mm = balance / 5 + misc.reduce((a, b) => a + b, 0)
        setMM(mm > 2 ? 2 : mm)

        document.querySelectorAll('#mc').forEach((iter, idx) => {
            let width = iter.clientWidth
            const { top, left } = iter.getBoundingClientRect()
            document.documentElement.style.setProperty('--miscleft' + idx, `${width + left}px`);
            document.documentElement.style.setProperty('--misctop' + idx, `${top}px`);
        })

        return LST.map((iter, idx) => {

            return (
                <div id="mc" key={'m' + idx} className={"control-btn " + (misc[idx] !== 0 ? 'selected ' : '') + (misc.reduce((a, b) => a + b, 0) === miscMax ? 'disabled' : '')} onClick={e => miscHandler(e, idx)} onContextMenu={e => miscRHandler(e, idx)}>
                    {iter}
                    {misc[idx] !== 0 && <div className={"counter" + idx}>{misc[idx]}</div>}
                </div>
            )
        })
    }
    // -------------------------------------------------Begin GoJS--------------------------------------------------------------------------
    function initDiagram() {
        const $ = go.GraphObject.make;
        const diagram =
            $(go.Diagram,
                {
                    'undoManager.isEnabled': true,  // must be set to allow for model change listening
                    // 'undoManager.maxHistoryLength': 0,  // uncomment disable undo/redo functionality
                    'clickCreatingTool.archetypeNodeData': { text: 'new node', color: 'lightblue' },
                    model: $(go.GraphLinksModel,
                        {
                            linkKeyProperty: 'id'  // IMPORTANT! must be defined for merges and data sync when using GraphLinksModel
                        })
                });

        // define a simple Node template
        diagram.nodeTemplate =
            $(go.Node, 'Auto',  // the Shape will go around the TextBlock
                new go.Binding('location', 'loc', go.Point.parse).makeTwoWay(go.Point.stringify),
                $(go.Shape, 'RoundedRectangle',
                    { name: 'SHAPE', fill: 'white', strokeWidth: 0 },
                    // Shape.fill is bound to Node.data.color
                    new go.Binding('fill', 'color')),
                $(go.TextBlock,
                    { margin: 8, editable: true },  // some room around the text
                    new go.Binding('text').makeTwoWay()
                )
            );

        return diagram;
    }
    function handleModelChange(changes) {
        alert('GoJS model changed!');
    }
    // -------------------------------------------------End GoJS--------------------------------------------------------------------------
    return (
        <div className="Content">
            <div className="state-wrapper" id="state-wrapper">
                <ReactDiagram
                    initDiagram={initDiagram}
                    divClassName='state-wrapper'
                    nodeDataArray={[
                        { id: -1, loc: "-104.32428965765573 -35.269613033399395", category: "Start" },
                        { id: -2, loc: "954.9736858363676 -117.59834133112157", category: "End" },
                        { text: "20 บาท", id: -3, loc: "203.02448955468762 -148.81443018750002" },
                        { text: "30 บาท", id: -4, loc: "212.5748958046876 -24.549463968750104" },
                        { text: "40 บาท", id: -5, loc: "204.32348706142548 200.07511480518326" },
                        { text: "20 บาท ไม่มีเครื่อง", id: -6, loc: "449.6020874296879 -148.75061610937513" },
                        { text: "30 บาท ไม่มีเครื่อง", id: -7, loc: "454.5134301903523 -46.699517621445125" },
                        { text: "30 บาท ไข่ 1 ฟอง", id: -8, loc: "462.0556464716025 35.420084628554974" },
                        { text: "40 บาท ไข่ 2 ฟอง", id: -9, loc: "439.93261895916055 236.15622686731137" },
                        { text: "ไก่สับ 2", id: -13, loc: "853.5620708441652 50.605603116567295" },
                        { text: "หมูสับ 1", id: -14, loc: "681.3151389189175 -18.920919401661507" },
                        { text: "หมูสับ 2", id: -15, loc: "852.2640760169915 -14.971123084259148" },
                        { text: "ไก่สับ 1", id: -16, loc: "681.8912442921401 45.410206563988055" },
                        { text: "ไก่สับ 2", id: -21, loc: "860.6591135332842 271.9525520067648" },
                        { text: "หมูสับ 2", id: -22, loc: "856.0980896448197 198.28229463136606" },
                        { text: "หมูสับ 1", id: -23, loc: "697.6096165665738 195.63601266005745" },
                        { text: "ไก่สับ 1", id: -24, loc: "698.1814303172887 270.7021824021952" },
                        { text: "Trap State", id: -18, logc: "1142.4315336328134 -12.52989423984377" }
                    ]}
                    linkDataArray={[
                        { from: -1, "to": -3, points: [-35.54255883910528, -18.45060229880329, 32.88423972995062, -63.71882825060368, 105.06423652692231, -99.86896380580873, 171.61504283837903, -122.85912437545257], text: "20 บาท" },
                        { from: -3, "to": -6, points: [234.4339362709962, -139.65514615437985, 283.56776802196214, -148.5221464310423, 332.8762989620125, -148.48027977288106, 382.4553512846684, -142.2436369940918], text: "ไข่ 1" },
                        { from: -6, "to": -2, points: [516.7488235747074, -132.23863846358273, 651.1733663243326, -129.0845571795013, 803.8791132747958, -114.16275702130459, 955.5659020355253, -86.73652594065743], text: "confirm" },
                        { from: -1, "to": -4, points: [-29.806273248775966, -3.7626474194103388, 40.846299684609264, -15.41862646229334, 110.67901495006768, -18.441584929245227, 181.165449088379, -12.315217347614878], text: "30 บาท" },
                        { from: -1, "to": -5, points: [-34.82384264590867, 21.78087010764777, 46.53663285357682, 71.61949486951784, 55.305534375000036, 168.95536875000016, 172.9140403451169, 205.30501776932482], text: "40 บาท" },
                        { from: -4, "to": -7, points: [243.9843425209962, -19.049578959890667, 289.7350508621471, -32.589972840240634, 337.46178525935085, -36.962161413439546, 387.3666940453328, -34.757370753923595], text: "ไข่ 2" },
                        { from: -4, "to": -8, points: [243.9843425209962, -8.039168955443, 297.8709659267698, -5.415763362618918, 341.47564374305136, 40.44437386826843, 396.9991050287314, 45.063750453923944], text: "ไข่ 1" },
                        { from: -5, "to": -9, points: [235.73293377773408, 214.42526371379947, 288.2984033646925, 213.4352516440713, 328.9934797734378, 247.91769351562525, 374.87607751628946, 249.2313412816194], text: "ไข่ 2" },
                        { from: -3, "to": -4, points: [186.82638244738285, -118.9389815791016, 177.75874202243006, -110.64155577903435, 181.25516404508718, -45.84267339791035, 199.2572030675623, -24.549463968750104], text: "30 บาท" },
                        { from: -4, "to": -3, points: [220.26839352068544, -24.549463968750104, 238.68609236472997, -59.98576030008673, 235.90909619648974, -91.46645062198877, 214.24168137979933, -118.9389815791016], text: "20 บาท" },
                        { from: -5, "to": -4, points: [179.09326912526228, 200.07511480518326, 163.48559062500013, 190.83448125000012, 162.2700843750001, 12.155062500000014, 181.4326940137404, 3.8634354943808624], text: "30 บาท" },
                        { from: -5, "to": -3, points: [172.9140403451169, 215.49763510001907, 79.61555672263387, 216.52819045654056, 97.84817199155158, -142.33639102171654, 171.61504283837903, -135.9913694496009], text: "20 บาท" },
                        { from: -1, "to": -1, points: [-48.074289657655726, 34.706339608517055, -27.074289657655726, 71.07940656746348, -106.57428965765573, 71.07940656746348, -85.57428965765573, 34.706339608517055] },
                        { from: -3, "to": -5, points: [234.4339362709962, -126.11190348964058, 302.0533031250002, -109.39556250000007, 288.6827343750002, 229.7306812500002, 235.73293377773408, 220.4927277192988], text: "40 บาท" },
                        { from: -4, "to": -5, points: [241.13029046818366, 5.325984639648336, 270.45014062500024, 20.663606250000015, 251.0020406250002, 182.32593750000012, 225.65531509407487, 200.07511480518326], text: "40 บาท" },
                        { from: -4, "to": -4, points: [221.19919495279743, 5.325984639648333, 242.19919495279743, 41.69905159859476, 182.95059665657777, 41.69905159859476, 203.95059665657777, 5.325984639648333] },
                        { from: -3, "to": -3, points: [194.4001904065778, -148.81443018750002, 174.07407497689027, -184.02029483222847, 231.97490413248497, -184.02029483222847, 211.64878870279745, -148.81443018750002] },
                        { from: -5, "to": -5, points: [212.9477862095353, 229.9505634135817, 233.9477862095353, 266.3236303725281, 174.69918791331565, 266.3236303725281, 195.69918791331565, 229.9505634135817] },
                        { from: -9, "to": -7, points: [467.8958763620284, 236.15622686731137, 627.5923680997312, 151.57958187435534, 536.4096047881435, 2.6465745195888744, 489.8112257342111, -16.82406901304669], text: "30 บาท" },
                        { from: -9, "to": -6, points: [497.45498774952097, 236.15622686731137, 679.7837426080364, 188.71354270795845, 549.5101388200837, -68.74574692511672, 472.46167801878414, -118.87516750097669], text: "20 บาท" },
                        { from: -7, "to": -9, points: [420.2894725888402, -16.824069013046685, 393.38462685094197, -4.737080788273165, 303.1412247489587, 161.46787163112876, 416.96202168928914, 236.15622686731137], text: "40 บาท" },
                        { from: -6, "to": -9, points: [431.31976423157965, -118.87516750097669, 408.7604982478286, -99.57471835126437, 263.3287933828127, 192.97377225000017, 394.5428884648861, 236.15622686731137], text: "40 บาท" },
                        { from: -7, "to": -6, points: [464.0540139194638, -46.699517621445125, 473.98141602305725, -61.54265780529035, 468.51106856848935, -94.4427592960004, 456.50661803358884, -118.8751675009767], text: "20 บาท" },
                        { from: -6, "to": -8, points: [382.4553512846684, -127.03658196315659, 371.8765402734378, -125.9689902187501, 319.61281028906274, 5.360382562500007, 414.7691239381811, 35.420084628554974], text: "30 บาท" },
                        { from: -8, "to": -6, points: [494.88007569462917, 35.420084628554974, 649.2763378828131, -34.84248665625003, 563.510216882813, -97.82698176562508, 496.8852666492138, -118.87516750097669], text: "20 บาท" },
                        { from: -9, "to": -9, points: [428.25100281732205, 266.0316754757098, 383.95373345468295, 322.67626892353155, 359.1324819990266, 283.89306352406857, 403.1337520667189, 266.0316754757098] },
                        { from: -8, "to": -8, points: [451.2999200450037, 65.29553323695342, 410.1697732042971, 122.41773677109381, 367.95676052460965, 109.75383296718758, 438.39037192740756, 65.29553323695342] },
                        { from: -7, "to": -7, points: [463.1377293384621, -16.824069013046692, 484.1377293384621, 19.548997945899732, 424.88913104224247, 19.548997945899732, 445.88913104224247, -16.824069013046692] },
                        { from: -6, "to": -6, points: [440.97778828157806, -148.75061610937513, 420.6516728518905, -183.95648075410358, 478.5525020074852, -183.95648075410358, 458.2263865777977, -148.75061610937513] },
                        { from: -9, "to": -23, points: [504.98916040203164, 243.29870828782464, 550.8798154699223, 237.79997142890636, 612.7922340667974, 209.6579629757814, 664.6683094987027, 210.2180693962412], text: "หมูสับ" },
                        { from: -9, "to": -24, points: [504.98916040203164, 253.77647029797907, 535.7327884656358, 255.3356723778169, 614.0211490962173, 283.0152652245271, 666.535754658109, 284.37087867108573], text: "ไก่สับ" },
                        { from: -14, "to": -15, points: [714.2564459867885, -7.08433212604678, 749.3165497286457, -10.865370288788117, 783.4043766090654, -12.865188727460806, 819.3227689491204, -5.814912705896628], text: "หมูสับ" },
                        { from: -14, "to": -13, points: [714.2564459867885, 3.608031179259161, 716.9176653433599, 4.221301267968784, 791.9690447729764, 23.427373994919034, 831.7162008668251, 50.605603116567295], text: "ไก่สับ" },
                        { from: -16, "to": -15, points: [713.5369199513198, 58.88674527712027, 739.4312721058599, 57.69111732890633, 797.1223894347661, 11.256803381250052, 819.3227689491204, 6.71129909383388], text: "หมูสับ" },
                        { from: -16, "to": -13, points: [713.5369199513198, 65.69839817278316, 757.7235776003911, 73.16922197812505, 791.4939877441411, 60.505318174218814, 821.9163951849855, 62.97467701912176], text: "ไก่สับ" },
                        { from: -8, "to": -14, points: [520.2758544948645, 35.420084628554974, 570.5792213871098, 22.513606762500046, 614.1993344894536, -2.8142008453124845, 648.3738318510464, -3.40943756079872], text: "หมูสับ" },
                        { from: -8, "to": -16, points: [527.1121879144736, 43.56035367194115, 568.8829962124388, 39.19591630229167, 626.8632382933598, 46.434313947656335, 650.2455686329604, 52.34644507342749], text: "ไก่สับ" },
                        { from: -14, "to": -8, points: [685.9731284085937, 10.954529206736932, 694.4040585808599, 37.99171141171877, 580.4289243457035, 28.142008453125072, 527.1121879144736, 38.14827000179111], text: "reset" },
                        { from: -15, "to": -8, points: [822.6369689155223, -14.971123084259148, 723.9531674566412, -64.72661944218751, 590.2786273042973, -46.43431394765625, 481.84402883312896, 35.420084628554974], text: "reset" },
                        { from: -16, "to": -8, points: [700.4102599419394, 75.2856551723865, 723.9531674566412, 94.2757283179688, 563.5437192738285, 122.41773677109381, 483.0937032274345, 65.29553323695342], text: "reset" },
                        { from: -13, "to": -8, points: [864.6870032734936, 80.48105172496572, 888.5839169074225, 112.56803381250006, 501.63130067695346, 144.93134353359386, 468.30655180334213, 65.2955332369534], text: "reset" },
                        { from: -15, "to": -2, points: [885.2053830848625, -9.907410897876394, 911.0430685274238, -17.56141512597148, 925.3543175546736, -58.69658990106812, 956.7282230592557, -68.76203281158553], text: "confirm" },
                        { from: -13, "to": -2, points: [885.2077465033449, 68.7533709613277, 926.8052506626077, 72.88153161147041, 964.6678710158183, -34.71484459156842, 972.7348879315449, -48.213707770853645], text: "confirm" },
                        { from: -23, "to": -22, points: [730.5509236344449, 203.32907290492045, 761.74462738918, 196.7188851150528, 792.6132851284431, 197.3139812651303, 823.1567825769486, 205.0285515439723], text: "หมูสับ" },
                        { from: -23, "to": -21, points: [730.5509236344449, 213.25300564762216, 740.7592231297417, 214.08329380503534, 801.2610235529039, 242.00720169264866, 840.8905860901828, 271.9525520067648], text: "ไก่สับ" },
                        { from: -24, "to": -22, points: [729.8271059764684, 281.7843611512491, 782.0803655410047, 275.88161390487807, 801.3881144864815, 236.1214434304024, 823.4627238027997, 226.7730154403844], text: "หมูสับ" },
                        { from: -24, "to": -21, points: [729.8271059764684, 289.8221868563348, 767.1318028013766, 294.75236103591817, 802.8123517688825, 285.4443917400471, 829.0134378741045, 286.09929004351824], text: "ไก่สับ" },
                        { from: -23, "to": -9, points: [685.6620155296417, 195.63601266005745, 663.192812330816, 167.54344732567984, 545.2918679164486, 153.5814933818732, 456.07237637576327, 236.15622686731137], text: "reset" },
                        { from: -22, "to": -9, points: [850.7427168901538, 198.28229463136606, 836.9415725204099, 159.78680624578726, 512.7139753808999, 83.77172366283992, 446.43018866583486, 236.15622686731137], text: "reset" },
                        { from: -24, "to": -9, points: [678.4383965997642, 300.5776310105936, 649.2308583870093, 322.67626892353155, 546.8431961324272, 316.4709560596174, 464.3601792267248, 266.0316754757098], text: "reset" },
                        { from: -21, "to": -9, points: [849.3365589084234, 301.8280006151632, 788.8503978250759, 381.6267411307151, 467.7254571175228, 341.29220751527373, 444.5353881353027, 266.0316754757098], text: "reset" },
                        { from: -22, "to": -2, points: [889.0393967126907, 206.68134376814427, 945.534547638906, 195.4673552132931, 967.2531426626052, 46.539846479355504, 985.1492388874292, -43.3205970162212], text: "confirm" },
                        { from: -21, "to": -2, points: [892.3047891924639, 285.292946561651, 1012.2416609259823, 279.239078876133, 1007.5876762780466, 68.25844150305477, 996.2743623774791, -42.79144039001086], text: "confirm" },
                        { from: -2, "to": -18, points: [1028.4767023501468, -69.60868919634845, 1063.0260835623667, -59.54256070266649, 1093.0102941837426, -43.04537527997768, 1126.1897560932657, -12.52989423984377] },
                        { from: -18, "to": -18, points: [1151.0558327809233, 17.345554368554666, 1172.0558327809233, 53.71862132750109, 1112.8072344847035, 53.71862132750109, 1133.8072344847035, 17.345554368554666] }
                    ]}
                    // onModelChange={handleModelChange}
                />
            </div>
            <header>
                <h1>Auto Omelettes</h1>
                <h2>make by ไข่เจียว</h2>
            </header>
            <div className="controller">
                <header>
                    <h3>Recipes</h3>
                    <h4>Lorem ipsum dolor sit amet, consectetur adipiscing elit.</h4>
                </header>
                <div className="content">
                    <div className="block">
                        <Icon icon={coinIcon} id="c-ico" />
                        <span>ราคา&nbsp;&nbsp;( บาท )</span>
                    </div>
                    <div className="block">
                        {priceComponent}
                    </div>
                    <div className="block">
                        <Icon icon={eggIcon} id="c-ico" />
                        <span>จำนวนไข่&nbsp;&nbsp;( ฟอง )</span>
                    </div>
                    <div className="block">
                        {eggComponent}
                    </div>
                    <div className="block">
                        <Icon icon={broccoliIcon} id="c-ico" />
                        <span>เลือกเครื่อง&nbsp;&nbsp;( เลือกซ้ำได้ คลิกขวาเพื่อรีเซ็ท )</span>
                        <span></span>
                        <span>{misc.reduce((a, b) => a + b, 0) + ' / ' + miscMax}</span>
                    </div>
                    <div className="block">
                        {miscComponent}
                    </div>
                </div>
                <footer>
                    <div className="total">
                        <span>Sub Total</span>
                        <span>฿ {price}</span>
                    </div>
                    <div className={"confirm noselect " + validation()}>Confirm</div>
                </footer>
            </div>
        </div>
    )
}